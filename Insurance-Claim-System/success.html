<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Submitted Successfully - Insurance Claim System</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navigation Header -->
    <header class="header">
        <div class="header-content">
            <button class="back-btn" onclick="goHome()">
                <i class="fas fa-home"></i>
            </button>
            <h1 class="header-title">Claim Status</h1>
            <div class="help-placeholder"></div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
        <div class="success-container">
            <!-- Success Icon -->
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            
            <!-- Success Message -->
            <h1 class="success-title">Claim Submitted Successfully!</h1>
            <p class="success-subtitle">Your insurance claim has been received and is being processed.</p>
            
            <!-- Claim Details -->
            <div class="claim-details">
                <div class="detail-item">
                    <i class="fas fa-calendar-alt"></i>
                    <div class="detail-content">
                        <span class="detail-label">Submission Date</span>
                        <span class="detail-value" id="submission-date"></span>
                    </div>
                </div>
                
                <div class="detail-item">
                    <i class="fas fa-file-alt"></i>
                    <div class="detail-content">
                        <span class="detail-label">Reference Number</span>
                        <span class="detail-value" id="reference-number"></span>
                    </div>
                </div>
                
                <div class="detail-item">
                    <i class="fas fa-clock"></i>
                    <div class="detail-content">
                        <span class="detail-label">Processing Time</span>
                        <span class="detail-value">3-5 business days</span>
                    </div>
                </div>
                
                <div class="detail-item">
                    <i class="fas fa-download"></i>
                    <div class="detail-content">
                        <span class="detail-label">Data Export</span>
                        <span class="detail-value">Downloaded automatically</span>
                    </div>
                </div>
            </div>
            
            <!-- Next Steps -->
            <div class="next-steps">
                <h3>What happens next?</h3>
                <ul>
                    <li>We will review your claim and supporting documents</li>
                    <li>You may be contacted for additional information</li>
                    <li>Updates will be sent to your registered email</li>
                    <li>Payment will be processed upon approval</li>
                </ul>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="btn-secondary" onclick="goHome()">
                    <i class="fas fa-home"></i>
                    Back to Home
                </button>
                <button class="btn-secondary" onclick="downloadAllFiles()">
                    <i class="fas fa-download"></i>
                    Download All Files
                </button>
                <button class="btn-primary" onclick="viewClaim()">
                    <i class="fas fa-eye"></i>
                    View Claim Status
                </button>
            </div>
        </div>
    </main>

    <script>
        // Generate reference number
        function generateReferenceNumber() {
            const prefix = 'INS';
            const timestamp = new Date().getTime().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}${timestamp}${random}`;
        }

        // Initialize success page
        function initSuccessPage() {
            // Set submission date
            const now = new Date();
            const dateOptions = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('submission-date').textContent = now.toLocaleDateString('en-US', dateOptions);
            
            // Set reference number
            document.getElementById('reference-number').textContent = generateReferenceNumber();
        }

        // Navigation functions
        function goHome() {
            // Clear storage when leaving success page
            localStorage.removeItem('insurance-claim-data');
            window.location.href = 'index.html';
        }

        function viewClaim() {
            alert('This feature will redirect to claim tracking system.');
            // In a real application, this would redirect to a claim tracking page
        }

        // Download all files function
        function downloadAllFiles() {
            try {
                // Get stored data from localStorage (using the correct key)
                const storedData = localStorage.getItem('insurance-claim-data');
                console.log('Retrieved data from localStorage:', storedData ? 'Data found' : 'No data found');
                
                if (!storedData) {
                    alert('No data found to export.');
                    return;
                }

                const data = JSON.parse(storedData);
                console.log('Parsed data:', data);
                
                // Show loading message
                const downloadBtn = document.querySelector('button[onclick="downloadAllFiles()"]');
                const originalText = downloadBtn.innerHTML;
                downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';
                downloadBtn.disabled = true;

                // Export JSON metadata (without Base64 data)
                exportJsonMetadata(data);

                // Export original files if they exist
                if (data.uploadedFiles && data.uploadedFiles.length > 0) {
                    console.log(`Found ${data.uploadedFiles.length} files to export`);
                    setTimeout(() => {
                        exportUploadedFiles(data.uploadedFiles);
                        
                        // Reset button after all downloads
                        setTimeout(() => {
                            downloadBtn.innerHTML = originalText;
                            downloadBtn.disabled = false;
                        }, data.uploadedFiles.length * 500 + 1000);
                    }, 1000);
                } else {
                    console.log('No files to export');
                    // Reset button if no files to download
                    setTimeout(() => {
                        downloadBtn.innerHTML = originalText;
                        downloadBtn.disabled = false;
                    }, 1000);
                }

            } catch (error) {
                console.error('Error downloading files:', error);
                alert('Error downloading files. Please try again.');
            }
        }

        // Export JSON metadata (without Base64 data)
        function exportJsonMetadata(data) {
            const exportData = {
                formData: data.formData || {},
                uploadedFiles: data.uploadedFiles ? data.uploadedFiles.map(file => ({
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    dataRemoved: true,
                    note: "Original file saved separately"
                })) : [],
                exportTime: new Date().toISOString(),
                note: "Uploaded files are saved as separate files alongside this JSON"
            };

            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `Insurance_Claim_Data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Export uploaded files in original format
        function exportUploadedFiles(files) {
            const baseDate = new Date().toISOString().split('T')[0];
            
            files.forEach((file, index) => {
                if (file.data) {
                    setTimeout(() => {
                        try {
                            // Convert Base64 to blob
                            const base64Data = file.data.split(',')[1];
                            const byteCharacters = atob(base64Data);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const blob = new Blob([byteArray], { type: file.type });
                            
                            // Create download link
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            
                            // Sanitize filename
                            const sanitizedName = sanitizeFileName(file.name);
                            link.download = `Insurance_Claim_Data_${baseDate}_file${index + 1}_${sanitizedName}`;
                            
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        } catch (error) {
                            console.error('Error downloading file:', file.name, error);
                        }
                    }, index * 500); // 500ms delay between downloads
                }
            });
        }

        // Sanitize filename for safe download
        function sanitizeFileName(filename) {
            return filename.replace(/[^a-zA-Z0-9\-_.]/g, '_');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initSuccessPage);
    </script>
</body>
</html>